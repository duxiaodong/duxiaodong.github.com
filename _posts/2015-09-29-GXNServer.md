---
layout: post
title: 高性能服务器编程 
description: ""
category: "网络编程 服务器"
tags: [服务器,网络编程]
---
{% include JB/setup %}

# 第1章 TCP/IP协议族

##1.1  TCP/IP协议族体系结构以及主要协议

1.TCP/IP是四层协议族，自底向上：数据链路层、网络层、传输层、应用层。上层协议使用下层协议提供的服务。

<center>![](/images/2015/9/ZYXYjiegou.png)</center>

###1.1.1数据链路层

1.数据链路层是实现网卡接口的网络驱动程序，用以处理数据在传输介质(以太网、令牌环等)上面传输。数据链路层有两个主要的协议：ARP（Address Resolve Protocol ,地址解析协议）和RARP（Reverse Address Protocol，逆地址解析协议）功能<font color=red>实现IP地址和机器物理地址（通常是MAC地址，以太网、802.11无线网络都使用MAC地址）之间的相互转换</font>。

2.ARP协议作用：网络层使用IP地址寻找主机，链路层通过物理地址寻找一台主机，网络层必须首先将目标IP地址转换为其对应的物理地址，这样才能使用链路层提供的服务，而提供这个转换服务的协议就是ARP协议。

###1.1.2 网络层

1. 网络层：实现数据包的<font color=red>选路和转发</font>。广域网通过众多的路由器来连接分散的主机或者局域网。
IP协议根据数据包的目的IP地址选择如何投递。假如数据包不能直接发送目的主机，那么IP协议就为它寻找一个合适的<font color=red>下一跳(next hop)路由器</font>，将数据包交付给该路由器来转发。多次重复到达目标主机或者由于发送失败而丢包。网络层使用了<font color=red>逐跳（next hop）</font>的方式通信。

2. ICMP（因特网控制报文协议)是IP协议的重要补充，主要作用是：检测网络连接。ping命令

###1.1.3 传输层

0. 传输层：传输层为两台主机上的应用程序提供<font color=red>端到端</font>的通信，与网络层的逐跳方式不同，传输层只关心通信的起始点和目的点，忽略数据包的中转过程。

<center>![](/images/2015/9/ChuangShu.png)</center>

    注意：虚线是逻辑通信，实线是实体通信。数据链路层（驱动程序）封装了物理网络的细节，传输层的主要协议：TCP、UDP、SCTP协议。

1. TCP协议（transmission control protocol 传输控制协议），为应用层提供<font color=red>可靠的、面向连接的、基于流</font>的服务，Tcp主要采用超时重传、数据确认等方式确保数据包正确发送到目的端，TCP可靠；使用TCP通信必须双方建立连接，并在内核中维持必要的数据结构，包括连接状态、读写缓冲区等。TCP是基于流的，基于流的数据没有长度限制，从通信一端流入另一端，发送端可以逐个字节写入，接收端也可以逐个字节读取。

2. UDP协议（user dategram protocol用户数据包协议）,为应用层提供了<font color=red>不可靠的、无连接的、基于数据报</font>的服务。UDP无法保证数据正确发送到目的端口，使用UDP一般要应用程序自己处理超时重传、数据确认等。无连接：UDP通信双方不需要保持长久的联系，因此应用程序每次都要指明接收端的地址。基于数据报：每个UDP数据报都有一个长度，接收端必须以该长度的最小长度读取，否则数据截断。

3. SCTP协议（stream control Transmission protocol,流控制传输协议)，主要为因特网上传输电话信号设计的。

###1.1.4应用层

1. 应用层：负责处理<font color=red>应用程序的逻辑</font>，数据链路层、网络层、传输层负责处理网络通信的细节，这部分稳定高效，因此是在<font color=red>内核</font>中实现的，应用层则在用户空间实现，负责众多逻辑，比如文本传输、名称查询、网络管理等。
>1. ping是应用程序而不是协议、利用了ICMP协议检测网络连接，调试网络环境。
>2. telnet协议-远程登陆协议、DNS。
>3. OSPF协议（开放最短路径优先）动态路由更新协议。

##1.2封装
1. 上层协议如何使用下层协议提供的服务，其实是通过<font color=red>封装</font>实现的，应用程序再发送到网络上之前，将沿着协议栈自上往下依次传递、依次封装上自己的头或者尾信息，以此来实现该层的功能。

<center>![](/images/2015/9/FengZhuang.png)</center>

2. 经过TCP封装后的数据为TCP报文段，TCP协议维持连接并且在内核存储相关数据。这部分数据包括TCP头部和TCP内核缓冲区（发送缓冲区和接收缓冲区）一起构成TCP报文段。


<center>![](/images/2015/9/TCPFengZhuang.png)</center>

>1. 基本过程：发送端应用程序使用send或者(write)函数向TCP连接写入数据，内核将数据复制到TCP内核发送缓冲区，然后TCP模块调用IP模块提供的服务，传递参数TCP报文段。
>2. 经过IP封装后的数据为<font color=red>IP数据报</font>，
>3. 经过数据链路层封装后的数据成为<font color=red>帧</font>，传输媒介不同，帧的类型就不同，比如以太网就是以太网帧，令牌网络上传输就是令牌环帧。

##1.3分用

1. 当帧到达目的主机时，将沿着协议栈自底向上依次传递。各层协议依次处理帧中本层负责的头部数据，以获取所需的信息，最终将处理后的帧数据交给目标应用程序。这个过程就是分用。

<center>![](/images/2015/9/FengYong.png)</center>

TCP报文段和UDP数据报是通过头部的端口号字段来区分上层应用，比如DNS协议端口53，HTTP协议对应端口是80

DNS工作原理：
通常使用机器的域名来访问机器，而不是直接使用IP地址，DNS功能：<font color=red>将机器的域名转换成IP地址</font>。
Linux下访问DNS服务，Linux下常用的访问DNS服务器的客户端程序是host ,`host -t A www.baidu.com ` 向首选DNS服务器请求查询机器www.baidu.com的

        sudo tcpdump -i eth0 -nt -s 500 port domain

IP 10.8.31.102.9681 > 172.16.7.30.53: 56532+ A? daisy.ubuntu.com. (34)
IP 172.16.7.30.53 > 10.8.31.102.9681: 56532 2/4/6 A 91.189.92.55, A 91.189.92.57 (272)
1. 数据包是通过IP指出的，tcpdump以“IP地址，端口号” 以“>"数据传输方向，”>"前面是源后面 是目的地。
理解：测试主机向第二DNS服务器发送DNS查询报文，第二个数据包是服务器反馈的DNS应答报文。

##1.7 TCP/IP协议族和socket的关系

1. 数据链路层、网络层、传输层在<font color=red>内核</font>中实现，因此操作系统需要实现一组系统调用，使得应用程序可以访问这些协议提供的服务，socket应运而生socket定义的这一组api提供了两个功能：

2. 将<font color=red>应用程序数据从用户缓冲区复制到TCP/UDP内核发送缓冲区</font>，交付内核来发送数据；或者从内核TCP/UDP接收缓冲区中复制到用户缓冲区，用来读取数据。

3. 应用程序可以使用它们<font color=red>修改内核中各协议的头部信息或者其他数据结构</font>，从而精准的控制底层的通信行为。如设置IP数据报再网络上的存活时间。

#第2章IP协议详解

1. IP头部信息出现在每个IP数据报中，包含了通信的源IP地址和目的地址IP，指导IP分片和重组。
2. IP数据报的路由和转发。IP数据报的路由和转发发生在除目的主机以外的其他主机和路由器上面。

##2.1 IP服务的特点

IP协议为上层协议提供了<font color=red>无状态、无连接、不可靠</font>的服务。

1. 无状态：IP通信双方不同步传输数据的状态信息。通信双方发送、传输、接收相互独立、没有上下文关系的。
 缺点：无法处理乱序，以及重复的IP数据报。
优点：简单、高校。无须为保持通信的状态而分配内核资源。面向连接的协议入TCP可以处理这种无序的、重复的IP数据报，它递交给上层应用的绝对正确的有序的。

2. 无连接：指IP通信双方都不长久的维持对方的通信信息。

3. 不可靠：IP协议不能保证IP数据报准确到达接收端。

##2.2 IP头部结构

<center>![](/images/2015/9/IPTou.png)</center>

4位版本号IP协议的版本
4位头部长度 标识IP头部有多少个字节（4字节）
8位服务类型：
16位总长度：整个IP数据报的长度，以字节为长度
16位标识符：唯一的标识主机发送的每一个数据报。
32位源端IP地址和目的端IP地址
选项：记录路由、时间戳、松散路由选择、严格路由选择。

##2.3 IP分片

1. 当IP数据报超过帧的MTU时候，IP数据报被分片传输，IP分片可以发生在发送机也可以在路由器上面，只有到达目标主机时，这些分片才会被内核中IP模块就行重组。
<center>![](/images/2015/9/FenPian.png)</center>
2. 以太网的MTU是1500个字节，假设传输1501个IP数据报，则必须进行分片传输，IP分片1包含1500个字节且头部含有一个标识MF标志和IP分片2包含21个字节（含有一个新的IP头部）
3. ICMP头部是8个字节，那么ICMP则是1472个ICMP数据报，剩下一个则放入下一个IP分片，因为Icmp是最后一个分片，则不需要进行Icmp头部。
IP数据报分片标识，标识相同说明是同一个IP数据报的分片，第一个分片的偏移是0，第二个偏移是1480，第二个分片的偏移就是ICMP报文的长度，第一个分片设置了 MF表示说明还有后续flag(+),没有后续了则flag(none);后面的每个分片的字节长度。
<center>![](/images/2015/9/1.png)</center>









